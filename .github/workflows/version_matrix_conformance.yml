name: Version Matrix Conformance

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main

jobs:
  matrix-conformance:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        lane: [n, n_minus_1, n_plus_1]
    env:
      RUSTUP_TOOLCHAIN: nightly
      VERSION_MATRIX_LANES: ${{ matrix.lane }}
      SHARED_BOUNDARY_BASE_SHA: ${{ github.event.pull_request.base.sha || github.event.before }}
      SHARED_BOUNDARY_HEAD_SHA: ${{ github.event.pull_request.head.sha || github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: version-matrix-conformance

      - name: Enforce SQLite wrapper policy guard
        run: ./scripts/check_no_local_sqlite_wrappers.sh ci

      - name: Enforce GA core delegate-cell guard
        run: ./scripts/check_ga_delegate_core_slots.sh ci

      - name: Run control-plane benchmark split gate suite
        run: ./scripts/run_control_plane_benchmark_split_gate_suite.sh ci

      - name: Run test262 ES2020 release-blocker suite
        run: ./scripts/run_test262_es2020_gate.sh ci

      - name: Run version-matrix lane script
        run: ./scripts/run_version_matrix_lane.sh ci

      - name: Upload matrix artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: version-matrix-${{ matrix.lane }}
          path: artifacts/version_matrix_lane/
