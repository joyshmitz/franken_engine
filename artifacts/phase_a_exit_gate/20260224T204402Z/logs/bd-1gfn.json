[
  {
    "id": "bd-1gfn",
    "title": "[PARSER-PHASE-4] Mathematical Error Recovery (Bayesian Diagnostics)",
    "description": "## Change:\nImplement Bayesian syntax-error recovery controller with strict bounded attempts, explicit confidence calibration, and execution-safe fallback semantics.\n\n## Hotspot evidence:\nHardcoded parser recovery heuristics can mis-repair syntax and create misleading downstream semantics; current strategy needs principled decisioning with deterministic guardrails.\n\n## Mapped graveyard sections:\n- `alien_cs_graveyard.md` §0.4 (decision layer), §0.8 (runtime decision core), §0.14 (calibration/optional-stopping), §0.17 (loss matrices)\n- `high_level_summary_of_frankensuite_planned_and_implemented_features_and_concepts.md` §0.16, §0.19, §1994\n\n## EV score:\n(Impact 4 * Confidence 3 * Reuse 4) / (Effort 4 * Friction 3) = 4.0\n\n## Priority tier:\nA\n\n## Adoption wedge:\nUse as tooling/diagnostic mode first; execution mode defaults to strict parse-fail unless confidence and policy criteria are met.\n\n## Budgeted mode:\n- Max recovery attempts per file\n- Max token-skips per attempt\n- Max inserted-token edits\n- On exhaustion: deterministic parse failure (no speculative continuation)\n\n## Expected-loss model:\nStates:\n- `S_recoverable`: file has local syntax defect recoverable without semantic distortion\n- `S_ambiguous`: multiple plausible repairs\n- `S_unrecoverable`: reliable repair not possible\nActions:\n- `A_recover_continue`, `A_partial_recover`, `A_fail_strict`\nLoss matrix:\n- `L(A_recover_continue,S_unrecoverable)=90`\n- `L(A_recover_continue,S_ambiguous)=55`\n- `L(A_fail_strict,S_recoverable)=12`\n- `L(A_partial_recover,S_ambiguous)=15`\n\n## Calibration + fallback trigger:\n- Fail strict if posterior confidence < threshold.\n- Fail strict if recovery path violates deterministic progression invariant.\n- Fail strict if recovered AST fails oracle parity checks.\n\n## Isomorphism proof plan:\n- Evaluate recovered outputs against curated repaired-golden corpus.\n- For execution-admissible recoveries, require semantic equivalence checks on declared invariant set.\n- Record decision ledger tuple `(evidence, posterior, action, loss)` per recovery.\n\n## p50/p95/p99 before/after target:\n- Recovery-mode false-positive repair rate <= 2%\n- Recovery-mode success on common typo corpus >= 90%\n- Strict mode parse latency non-regression within +10% p99\n\n## Primary failure risk + countermeasure:\nRisk: overconfident repair induces silent semantic corruption.\nCountermeasure: conservative loss matrix, strict confidence threshold, and execution-mode default-to-fail policy.\n\n## Repro artifact pack:\n- `artifacts/parser_phase4_recovery/baseline.json`\n- `artifacts/parser_phase4_recovery/recovery_decision_log.jsonl`\n- `artifacts/parser_phase4_recovery/golden_checksums.txt`\n- `artifacts/parser_phase4_recovery/proof_note.md`\n- `artifacts/parser_phase4_recovery/env.json`\n- `artifacts/parser_phase4_recovery/manifest.json`\n- `artifacts/parser_phase4_recovery/repro.lock`\n\n## Primary paper status (checklist):\nStatus: hypothesis\n- [ ] Bayesian recovery references reviewed\n- [ ] calibration methodology documented\n- [ ] false-positive tradeoff analysis captured\n- [ ] promotion policy approved\n\n## Interference test status:\nRequires interference report from parallel path gate (`bd-3rjg`) before enabling recovery atop parallel parser mode.\n\n## Demo linkage:\n- `demo_id`: `demo.parser.phase4.bayesian_recovery`\n- `claim_id`: `claim.parser.phase4.safe_error_recovery`\n\n## Rollback:\nDisable recovery controller and run strict parse-fail mode only if calibration, parity, or deterministic-progression checks fail.\n\n## Baseline comparator:\nAd-hoc heuristic recovery and strict parse-fail behavior currently in use.\n\n## Detailed sub-tasks:\n1. Define evidence features and posterior update math.\n2. Define conservative loss matrix and policy thresholds.\n3. Implement deterministic bounded-recovery engine.\n4. Add decision/evidence logging and replay checks.\n5. Validate against repaired-golden corpus and oracle gate.\n\n## User-outcome optimization addendum:\n- Recovery behavior must be transparent: users need to know when the parser repaired input, what changed, and why strict failure was chosen otherwise.\n- Keep strict mode as default safety path while exposing diagnostic recovery reports for editor and tooling workflows.\n- Recovery explanations should include confidence, selected action, rejected alternatives, and deterministic replay token.\n\n## Mandatory test and e2e contract:\n- Unit tests: posterior update math, loss matrix decision policy, bounded-attempt invariants, deterministic action selection, explanation generator.\n- Integration tests: strict-vs-recovery mode behavior, oracle parity post-recovery, composition with serial and parallel parser modes, fallback trigger correctness.\n- E2E scripts with detailed logging:\n  - `scripts/e2e/parser_phase4_recovery_smoke.sh`\n  - `scripts/e2e/parser_phase4_recovery_typo_corpus.sh`\n  - `scripts/e2e/parser_phase4_recovery_false_positive_guard.sh`\n  - `scripts/e2e/parser_phase4_recovery_replay.sh`\n- Logs must include: trace_id, run_id, input_hash, parser_mode, recovery_mode, decision_id, evidence_features_hash, posterior_score, action, rejected_actions, loss_vector, fallback_reason, outcome, error_code.\n\n## Granular TODO checklist:\n1. Define deterministic evidence feature schema and hashing contract.\n2. Define posterior update implementation and numeric determinism constraints.\n3. Define conservative loss matrix and policy thresholds.\n4. Implement bounded recovery attempt engine with progression invariants.\n5. Implement strict-default gate and confidence eligibility criteria.\n6. Implement decision ledger and explanation renderer.\n7. Implement parity verifier for recovered AST against oracle invariants.\n8. Implement false-positive guardrails and degraded-mode behavior.\n9. Implement rollback switch and strict-only emergency mode drills.\n10. Add unit tests for posterior math, policy, and progression invariants.\n11. Add integration/e2e suites for typo success, false-positive suppression, fallback, and replay.\n12. Publish operator and developer playbook for interpreting recovery decisions.\n\n## Refinement pass 2: recovery transparency and safe rollout ergonomics\n- Emit deterministic repair-diff artifact (`repair_diff.jsonl`) so users can inspect exactly what the recovery controller changed.\n- Add explicit mode policy table: `strict_default`, `diagnostic_recovery`, `execution_recovery` with hard safety boundaries.\n- Require confidence-calibration report that includes false-positive/false-negative frontier and chosen operating point rationale.\n\n## Additional e2e scripts:\n- `scripts/e2e/parser_phase4_recovery_mode_policy_matrix.sh`\n- `scripts/e2e/parser_phase4_recovery_repair_diff_audit.sh`\n\n## Additional required log fields:\n- `schema_version`, `mode_policy`, `repair_diff_hash`, `confidence_threshold`, `operating_point_id`, `safety_boundary`, `replay_command`\n\n## TODO extensions:\n13. Implement repair-diff artifact generator and validator.\n14. Implement explicit recovery mode-policy matrix with gating checks.\n15. Add calibration frontier report and operating-point selection artifact.\n16. Add mode-transition safety tests to prevent accidental execution-mode enablement.\n17. Add remediation mapping for each recovery failure class.",
    "acceptance_criteria": "1. Recovery decisions emit deterministic evidence, posterior, action, and explanation logs suitable for exact replay.\n2. Comprehensive unit tests validate posterior math, loss-policy decisions, bounded-attempt behavior, deterministic action selection, mode-policy gating, and repair-diff integrity.\n3. Deterministic integration and end-to-end scripts cover normal, boundary, failure, and adversarial cases with stable outcomes.\n4. Structured log assertions verify fields: schema_version, trace_id, run_id, input_hash, parser_mode, recovery_mode, mode_policy, decision_id, evidence_features_hash, posterior_score, confidence_threshold, operating_point_id, action, rejected_actions, loss_vector, repair_diff_hash, safety_boundary, replay_command, fallback_reason, outcome, error_code.\n5. Recovery accuracy and false-positive guardrail targets are met on pinned typo and adversarial corpora with reproducible evidence.\n6. Execution safety defaults to strict failure unless calibrated confidence, parity checks, mode-policy constraints, and safety boundaries pass.\n7. Rollback path to strict parse-fail mode is documented, drill-tested, and reproducible.\n8. Composition with interference-gated parallel path remains explicitly blocked until deterministic composition criteria are green.",
    "status": "open",
    "priority": 1,
    "issue_type": "task",
    "assignee": "PearlTower",
    "created_at": "2026-02-24T00:26:02.381626804Z",
    "created_by": "ubuntu",
    "updated_at": "2026-02-24T11:58:09.516534997Z",
    "source_repo": ".",
    "compaction_level": 0,
    "original_size": 0,
    "dependencies": [
      {
        "id": "bd-2mds",
        "title": "Epic: Parser Frontier Program (active)",
        "status": "in_progress",
        "priority": 0,
        "dependency_type": "parent-child"
      },
      {
        "id": "bd-3rjg",
        "title": "[PARSER-PHASE-3.5] Parallel parsing interference + determinism gate",
        "status": "open",
        "priority": 1,
        "dependency_type": "blocks"
      }
    ],
    "dependents": [
      {
        "id": "bd-ntq",
        "title": "[10.2] VM Core - Comprehensive Execution Epic",
        "status": "open",
        "priority": 0,
        "dependency_type": "blocks"
      },
      {
        "id": "bd-1csl",
        "title": "[PHASE-A] Native VM Substrate Exit Gate",
        "status": "open",
        "priority": 1,
        "dependency_type": "blocks"
      }
    ],
    "comments": [
      {
        "id": 230,
        "issue_id": "bd-1gfn",
        "author": "Dicklesworthstone",
        "text": "## Implementation Complete — parser_error_recovery.rs\n\n**Module**: `crates/franken-engine/src/parser_error_recovery.rs` (1445 lines)\n**Tests**: 47 unit tests, all passing, clippy clean\n\n### Types & Functions\n- `RecoveryMode` (Strict/Diagnostic/Execution), `ErrorState` (Recoverable/Ambiguous/Unrecoverable)\n- `RecoveryAction` (RecoverContinue/PartialRecover/FailStrict)\n- `EvidenceFeatures` — deterministic feature extraction with content-hash\n- `StateProbabilities` — posterior state over {recoverable, ambiguous, unrecoverable}\n- `bayesian_update()` — evidence-conditioned posterior update (fixed-point millionths)\n- `LossMatrix` — 3×3 action×state loss matrix with expected loss computation\n- `select_action()` — Bayes-optimal action selection via minimum expected loss\n- `RecoveryConfig` — full config: mode, budget, prior, loss matrix\n- `RepairEdit` (Insert/Delete/Replace/Skip), `RecoveryAttempt`, `DecisionLedger`\n- `RecoveryOutcome` (CleanParse/Recovered/PartiallyRecovered/StrictFailed/RecoveryFailed/BudgetExhausted)\n- `run_recovery()` — main entry point: iterates errors, applies Bayesian updates, selects actions\n- `CalibrationReport` — FPR/FNR metrics for model calibration\n- `ModePolicyEntry` + `mode_policy_table()` — mode-specific safety policies\n\n### Design\n- All arithmetic in fixed-point millionths (1_000_000 = 1.0) for determinism\n- Strict mode always fails on errors; Diagnostic allows repair; Execution gates on confidence\n- Decision ledger provides full audit trail of Bayesian reasoning per recovery attempt\n- Integrates with parser pipeline: SWAR lexer → parallel parser → interference gate → error recovery\n\nImplemented by PearlTower.\n",
        "created_at": "2026-02-24T11:44:23Z"
      },
      {
        "id": 231,
        "issue_id": "bd-1gfn",
        "author": "Dicklesworthstone",
        "text": "## Implementation Complete — bayesian_error_recovery.rs\n\n**Module**: `crates/franken-engine/src/bayesian_error_recovery.rs`\n**Tests**: 67 passing (0 failures)\n**Clippy**: Clean (-D warnings)\n\n### Architecture\n- **Posterior model**: 3-state (Recoverable, Ambiguous, Unrecoverable), fixed-point millionths\n- **Bayesian update**: evidence features → likelihood ratios → posterior normalization\n- **Loss matrix**: 3x3 (actions × states) with expected-loss minimization\n- **Recovery modes**: StrictDefault (fail on any error), DiagnosticRecovery (evaluate but don't apply), ExecutionRecovery (apply if confident)\n- **Bounded attempts**: max attempts, max skips, max insertions per file\n- **Confidence gate**: MAP posterior must exceed threshold for recovery acceptance\n- **Repair diff**: deterministic content-addressed diff artifact for transparency\n- **Decision ledger**: evidence hash, posterior, action, rejected alternatives, replay command\n\n### Key types\nRecoveryMode, ErrorState, RecoveryAction, EvidenceFeatures, Posterior, LossMatrix,\nRecoveryConfig, RepairCandidate, RecoveryAttempt, RecoveryDecision, RepairEdit,\nRepairDiff, RecoveryEvent, RecoveryError, RecoveryResult, ErrorSite, RecoveryController\n\n### Evidence features driving likelihood\n- Typo pattern match → strongly favors Recoverable\n- Multiple candidates → favors Ambiguous\n- No candidates → strongly favors Unrecoverable\n- Statement boundary → favors Recoverable\n- High skip/insert count → disfavors Recoverable\n- Few preceding tokens → increases uncertainty\n\n### Cross-references\n- Upstream: bd-3rjg (interference gate), bd-1vfi (parallel parser)\n",
        "created_at": "2026-02-24T11:58:09Z"
      }
    ],
    "parent": "bd-2mds"
  }
]
