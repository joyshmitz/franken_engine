[
  {
    "id": "bd-1pi9",
    "title": "[TEST] Comprehensive unit test suite for franken-engine crate",
    "description": "## Plan Reference\nCross-cutting: 10.2 (VM Core), AGENTS.md (testing policy: add/maintain focused unit tests alongside changed logic).\n\n## What\nComprehensive unit test suite for the franken-engine crate covering parser, AST, multi-level IR, lowering pipelines, interpreter, object model, closures, promises, async semantics, GC, and module runtime. This is not the test262 conformance suite (that's bd-11p) — this is the internal unit test coverage ensuring each component works correctly in isolation.\n\n## Detailed Requirements\n- Parser unit tests: valid/invalid ES2020 syntax for all major constructs (declarations, expressions, statements, modules, async/await, generators, destructuring, template literals, etc.)\n- AST canonical serialization tests: verify deterministic byte output for identical source\n- IR lowering tests per level: IR0→IR1 (semantic preservation), IR1→IR2 (capability annotation, no ambient effects), IR2→IR3 (optimization legality, authority preservation), witness emission at each stage\n- Interpreter tests: arithmetic, comparison, assignment, control flow, function calls, prototype chains, closures, exception handling, Promise resolution/rejection, microtask ordering, async/await\n- Engine lane tests: HybridRouter routing decisions with deterministic reasons, QuickJsInspiredNative and V8InspiredNative lane-specific behavior\n- Error contract tests: all typed error variants produce deterministic messages with correct error codes\n- GC tests: allocation, collection, deterministic collection ordering in test mode, pause-time measurement\n- Module tests: resolve, load, cache, invalidate, policy hook integration\n- Each test must emit structured logs verifiable by the log assertion framework\n- All tests must be deterministic (no flaky tests, no timing-dependent assertions)\n- Test coverage target: >= 80% line coverage for all non-trivial modules\n\n## Rationale\nThe plan requires 'focused unit tests alongside changed logic' (AGENTS.md) and deterministic tests (testing policy). This bead ensures comprehensive coverage exists before integration and E2E testing layers are added. Unit tests are the first line of defense against regressions and the fastest feedback loop for developers.\n\n## Acceptance Criteria\n- Every public API in franken-engine has at least one positive and one negative unit test\n- Every error variant is tested\n- Every IR lowering path has at least one test verifying semantic preservation\n- All tests pass deterministically (run 3x, identical results)\n- Test execution uses rch for compilation offloading",
    "acceptance_criteria": "1. Implement the full test objective with deterministic execution semantics and explicit failure classification.\n2. Add focused unit tests for normal, boundary, invalid/adversarial, and invariant paths.\n3. Add end-to-end/integration scripts that exercise lifecycle transitions and failure-recovery behavior with fixed seeds/fixtures.\n4. Assert structured logs for critical events using stable fields (`trace_id`, `decision_id`, `policy_id`, `component`, `event`, `outcome`, `error_code`).\n5. Emit reproducibility artifacts (run manifest, fixture digests, replay pointers, benchmark/check outputs) and verifier commands.\n6. Run/document CPU-intensive `cargo` build/test commands through `rch` wrappers.",
    "notes": "MistyRiver session 3: Fixed ArmCca missing from external test files (tests/tee_attestation_policy.rs and tests/receipt_verifier_pipeline.rs). Added ArmCca measurements+trust roots. All integration tests pass.",
    "status": "open",
    "priority": 1,
    "issue_type": "task",
    "assignee": "TurquoiseElk",
    "created_at": "2026-02-20T12:50:22.736091726Z",
    "created_by": "ubuntu",
    "updated_at": "2026-02-22T19:21:28.463384120Z",
    "source_repo": ".",
    "compaction_level": 0,
    "original_size": 0,
    "labels": [
      "plan",
      "section-10-2",
      "testing",
      "unit-tests",
      "vm-core"
    ],
    "dependencies": [
      {
        "id": "bd-ntq",
        "title": "[10.2] VM Core - Comprehensive Execution Epic",
        "status": "open",
        "priority": 0,
        "dependency_type": "blocks"
      },
      {
        "id": "bd-8no5",
        "title": "[TEST] E2E test harness infrastructure and deterministic test runner",
        "status": "closed",
        "priority": 1,
        "dependency_type": "blocks"
      },
      {
        "id": "bd-3vk",
        "title": "[10.3] Memory + GC - Comprehensive Execution Epic",
        "status": "open",
        "priority": 3,
        "dependency_type": "blocks"
      }
    ],
    "dependents": [
      {
        "id": "bd-1csl",
        "title": "[PHASE-A] Native VM Substrate Exit Gate",
        "status": "open",
        "priority": 1,
        "dependency_type": "blocks"
      },
      {
        "id": "bd-1tsf",
        "title": "[MASTER] Execute PLAN 10.x end-to-end with full dependency graph",
        "status": "open",
        "priority": 3,
        "dependency_type": "related"
      }
    ],
    "comments": [
      {
        "id": 31,
        "issue_id": "bd-1pi9",
        "author": "Dicklesworthstone",
        "text": "## Plan Reference\nCross-cutting unit testing for franken-engine crate. Covers 10.2 (VM Core), 10.3 (Memory+GC), 10.7 (Scheduler), 10.8 (Benchmark).\n\n## What\nComprehensive unit test suite for the franken-engine crate. Every module in crates/franken-engine/ must have thorough unit tests covering normal paths, boundary conditions, invalid inputs, and invariant enforcement.\n\n### Coverage Targets\n- Line coverage: >= 90% for all security-critical modules (IR pipeline, execution, GC, scheduler).\n- Branch coverage: >= 80% for complex decision paths (type dispatch, error handling).\n- All public API functions have at least one positive test and one negative test.\n- All error types have tests that trigger them.\n\n### Test Organization\n- Tests live in the same file as the module they test (Rust inline #[cfg(test)] modules).\n- Test helpers/fixtures in tests/ directory for integration-level tests.\n- Deterministic: all tests use fixed seeds and virtual time where applicable.\n- Structured logging assertions: tests verify correct structured log events are emitted.\n\n## Dependencies\nDepends on: bd-ntq (toolchain operational for test compilation)",
        "created_at": "2026-02-20T14:59:12Z"
      },
      {
        "id": 157,
        "issue_id": "bd-1pi9",
        "author": "Dicklesworthstone",
        "text": "Session 4 complete: +195 tests (benchmark_e2e: 33, flamegraph_pipeline: 68, operator_safety_copilot: 94). All 159/159 source files now have test modules. Grand total: ~864 tests added across 4 sessions. Full suite: 6,010 lib tests, 0 failures, 0 warnings. Remaining: formal coverage measurement.",
        "created_at": "2026-02-22T08:37:36Z"
      },
      {
        "id": 158,
        "issue_id": "bd-1pi9",
        "author": "Dicklesworthstone",
        "text": "Session 5: Fixed compilation errors in shadow_ablation_engine.rs and replacement_lineage_log.rs tests. Added 25 more tests for module_compatibility_matrix.rs covering validate_entry (shim validation, divergence metadata, runtime set mismatch, empty migration guidance), evaluate_observation (behavior match/mismatch, all 5 runtime/mode combos), to_json_pretty round-trip, canonical_hash, and event sequencing. All 4 previously-under-80% files now exceed 80% line coverage. Full suite: 6,153 tests, 0 failures. Overall coverage: 92.04%.",
        "created_at": "2026-02-22T09:45:42Z"
      },
      {
        "id": 159,
        "issue_id": "bd-1pi9",
        "author": "Dicklesworthstone",
        "text": "Session 6 final verification (TurquoiseElk): All 3 compiler gates passed (cargo check, clippy -D warnings, fmt --check). Full test suite: 6,214 lib tests passing (6,153 engine + 42 extension-host + 19 metamorphic), 0 failures. Previously failing conformance_harness::reduce_output_lines_empty_inputs test now also passes. Overall line coverage: 92.04%. All 4 previously-low-coverage files now above 80%: shadow_ablation_engine (85.31%), replacement_lineage_log (90.59%), module_compatibility_matrix (97.77%), control_plane/mod (83.08%).",
        "created_at": "2026-02-22T09:51:58Z"
      },
      {
        "id": 160,
        "issue_id": "bd-1pi9",
        "author": "Dicklesworthstone",
        "text": "TurquoiseElk claiming: 12 files still below 80% line coverage. Biggest gaps: benchmark_e2e.rs (43%), storage_adapter.rs (59%), test262_release_gate.rs (69%), conformance_harness.rs (70%), release_checklist_gate.rs (70%), safe_mode_fallback.rs (71%), tee_attestation_policy.rs (72%), error_code.rs (72%), lowering_pipeline.rs (73%), ts_normalization.rs (77%), receipt_verifier_pipeline.rs (79%). Targeting 5-6 of these to bring above 80%. Overall coverage currently 92.04% with 6,214 tests passing.",
        "created_at": "2026-02-22T17:53:01Z"
      },
      {
        "id": 164,
        "issue_id": "bd-1pi9",
        "author": "Dicklesworthstone",
        "text": "Session 5 complete: Added 72 tests to ts_normalization.rs (9→81, 77%→80%+) and 50 tests to receipt_verifier_pipeline.rs (7→57, 79%→80%+). Full suite: 6,830 lib tests passing, 0 failures. All previously-identified below-80% modules now addressed: storage_adapter, security_e2e, benchmark_e2e, test262_release_gate, error_code, tee_attestation_policy, safe_mode_fallback, lowering_pipeline, conformance_harness, release_checklist_gate, ts_normalization, receipt_verifier_pipeline.",
        "created_at": "2026-02-22T19:21:28Z"
      }
    ]
  }
]
