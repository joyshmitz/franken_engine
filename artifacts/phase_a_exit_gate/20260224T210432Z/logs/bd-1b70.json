[
  {
    "id": "bd-1b70",
    "title": "[PARSER-ORACLE] Semantic equivalence + metamorphic proof gate",
    "description": "## Change:\nCreate a mandatory parser oracle/proof gate that combines pinned ES2020 corpus slices, metamorphic invariants, and deterministic artifact verification for every parser mode.\n\n## Hotspot evidence:\nWithout a first-class oracle, optimization phases can silently introduce semantic drift while still passing local unit tests.\n\n## Mapped graveyard sections:\n- `alien_cs_graveyard.md` §0.3 (isomorphism proof), §0.7 (artifact contract), §6.12 (property testing), §6.15 (delta debugging)\n- `high_level_summary_of_frankensuite_planned_and_implemented_features_and_concepts.md` §0.2, §0.11, §0.19, §0.20\n\n## EV score (Impact * Confidence * Reuse / Effort * Friction):\n(5 * 5 * 5) / (3 * 2) = 20.83\n\n## Priority tier:\nS\n\n## Adoption wedge:\nIntroduce as CI-required parser gate (`parser_oracle_gate`) first in report-only mode for 1 week, then switch to fail-closed mode.\n\n## Budgeted mode:\n- Max corpus files per run (tiered: smoke/full/nightly)\n- Max fuzz cases per seed budget\n- Max shrinking iterations for failing cases\n- On exhaustion: mark run `incomplete_budgeted`, do not promote optimized parser changes\n\n## Expected-loss model:\nStates:\n- `S_equivalent`: parser mode behavior matches scalar reference\n- `S_drift_minor`: non-critical divergence\n- `S_drift_critical`: semantic divergence on required invariants\nActions:\n- `A_promote`, `A_hold`, `A_reject`\nLoss matrix:\n- `L(A_promote,S_drift_critical)=120`\n- `L(A_promote,S_drift_minor)=35`\n- `L(A_hold,S_equivalent)=6`\n- `L(A_reject,S_equivalent)=10`\n\n## Calibration + fallback trigger:\n- Fallback to scalar reference if any critical metamorphic invariant fails.\n- Fallback if drift-rate exceeds calibrated bound for two consecutive windows.\n- Fallback if artifact hash verification fails for oracle evidence bundle.\n\n## Isomorphism proof plan:\n- For each parser mode, compare canonical AST hash and normalized diagnostic tuple against scalar reference.\n- Store per-input witness tuple: `(mode_hash, reference_hash, relation_results, decision)`.\n- Require deterministic replay of failing seeds with identical minimized counterexample.\n\n## p50/p95/p99 before/after target:\n- p50 oracle overhead <= +15% on smoke suite\n- p95 oracle overhead <= +25% on full suite\n- p99 oracle overhead <= +35% on nightly suite\n(Overhead accepted for safety gate; correctness is primary.)\n\n## Primary failure risk + countermeasure:\nRisk: flaky oracle due to non-deterministic corpus order or unstable fuzz seeds.\nCountermeasure: deterministic seed derivation, sorted corpus traversal, pinned tooling versions in repro lock.\n\n## Repro artifact pack:\n- `artifacts/parser_oracle/baseline.json`\n- `artifacts/parser_oracle/relation_report.json`\n- `artifacts/parser_oracle/minimized_failures/`\n- `artifacts/parser_oracle/golden_checksums.txt`\n- `artifacts/parser_oracle/proof_note.md`\n- `artifacts/parser_oracle/env.json`\n- `artifacts/parser_oracle/manifest.json`\n- `artifacts/parser_oracle/repro.lock`\n\n## Primary paper status (with checklist state):\nStatus: hypothesis\nChecklist:\n- [ ] Metamorphic relation set validated against known parser defects\n- [ ] Delta-debug strategy validated on seeded failures\n- [ ] Coverage and power analysis documented\n- [ ] Promotion criteria signed off\n\n## Interference test status:\nRequired when multiple parser modes are compared concurrently; must prove comparison harness itself is deterministic.\n\n## Demo linkage:\n- `demo_id`: `demo.parser.oracle_gate`\n- `claim_id`: `claim.parser.semantic_equivalence_gate`\n\n## Rollback:\nIf oracle gate regresses determinism or becomes unstable, revert to previous gate version and freeze optimized-parser promotions until oracle determinism is restored.\n\n## Baseline comparator:\nExisting parser tests without oracle-equivalence enforcement.\n\n## Detailed sub-tasks:\n1. Define required corpus partitions (smoke/full/nightly).\n2. Define mandatory metamorphic relation families.\n3. Implement deterministic comparator harness across parser modes.\n4. Implement minimization pipeline for failing cases.\n5. Emit artifact bundle + claim linkage.\n6. Enforce CI promotion gate wiring.\n\n## User-outcome optimization addendum:\n- Promotion decisions must be explainable to operators and developers in one pass: every oracle failure outputs a short diagnosis summary, top divergence examples, and exact replay command.\n- Keep report-only warmup mode mandatory before fail-closed so users can tune corpus quality and shrink false alarms without blocking unrelated velocity.\n- Add failure taxonomy that distinguishes parser semantic drift, diagnostics drift, harness nondeterminism, and artifact-integrity failure.\n\n## Mandatory test and e2e contract:\n- Unit tests: relation correctness, comparator determinism, seed derivation, shrinker correctness, artifact manifest validator.\n- Integration tests: scalar-vs-optimized mode parity, fallback trigger behavior, CI gate mode transitions (report-only to fail-closed).\n- E2E scripts with detailed logging:\n  - `scripts/e2e/parser_oracle_smoke.sh`\n  - `scripts/e2e/parser_oracle_full.sh`\n  - `scripts/e2e/parser_oracle_nightly.sh`\n  - `scripts/e2e/parser_oracle_replay_failure.sh`\n- Logs must include: trace_id, run_id, seed, corpus_partition, input_hash, parser_mode, relation_id, comparator_decision, drift_class, fallback_reason, artifact_hash, outcome, error_code.\n\n## Granular TODO checklist:\n1. Define corpus manifest schema and partition policy (smoke/full/nightly).\n2. Define deterministic seed derivation and transcript format.\n3. Define required metamorphic relation families and negative controls.\n4. Implement comparator core for AST hash + diagnostics tuple parity.\n5. Implement drift classifier with stable severity taxonomy.\n6. Implement deterministic minimizer with replay equivalence checks.\n7. Implement artifact pack validator and checksum gate.\n8. Implement operator-readable summary generator with top divergences.\n9. Implement report-only gate mode and confidence telemetry.\n10. Implement fail-closed gate mode with explicit promotion lock.\n11. Add exhaustive unit/integration/e2e tests and golden fixtures.\n12. Publish reproducibility guide with exact replay commands.\n\n## Refinement pass 2: oracle ergonomics + determinism envelope\n- Add deterministic environment bootstrap wrapper for all oracle scripts.\n- Emit `schema_version` and `taxonomy_version` in relation reports and summaries.\n- Add operator drift dashboard digest artifact (`drift_digest.md`) with ranked divergence clusters.\n- Require failure-code mapping from drift class to remediation steps.\n\n## Additional e2e scripts:\n- `scripts/e2e/parser_oracle_ci_matrix.sh`\n- `scripts/e2e/parser_oracle_flake_probe.sh`\n\n## Additional required log fields:\n- `schema_version`, `taxonomy_version`, `toolchain_fingerprint`, `cpu_feature_profile`, `replay_command`, `drift_cluster_id`, `owner_hint`\n\n## TODO extensions:\n13. Implement deterministic env bootstrap for oracle scripts.\n14. Add schema/taxonomy version checks in artifact validator.\n15. Add drift clustering and owner-hint generation.\n16. Add flake-probe rerun script with deterministic window policy.\n17. Emit drift digest markdown for operator-first triage.",
    "acceptance_criteria": "1. Oracle comparator enforces semantic parity between scalar reference and optimized parser modes across smoke, full, and nightly partitions.\n2. Comprehensive unit tests cover comparator logic, metamorphic relations, seed determinism, minimization, artifact validation, and schema-version checks.\n3. Deterministic integration and end-to-end scripts validate normal, boundary, failure, and adversarial behaviors with stable outcomes.\n4. Structured log assertions verify fields: schema_version, taxonomy_version, trace_id, run_id, seed, corpus_partition, input_hash, parser_mode, relation_id, comparator_decision, drift_class, drift_cluster_id, fallback_reason, artifact_hash, replay_command, outcome, error_code.\n5. Deterministic environment bootstrap and toolchain plus CPU fingerprints are captured and reproducible.\n6. Drift detection, fallback triggers, and gate-mode transitions are calibrated, test-covered, and reproducible.\n7. Failure minimization emits replayable minimized counterexamples with identical decisions across reruns.\n8. Repro artifact bundle includes machine evidence, operator summary, drift digest, and exact replay commands.\n9. CI promotion gate fails closed when parity, determinism, artifact completeness, or schema/taxonomy compatibility checks are unmet after warmup policy is satisfied.",
    "notes": "Implemented parser-oracle core lane: added parser_oracle module (partitioning, drift taxonomy, expected-loss decisioning), report binary, e2e wrappers, gate runner script, and docs; added parser_oracle_gate integration tests. Heavy validation executed via rch: cargo fmt --check, cargo check --all-targets, cargo clippy --all-targets -- -D warnings, cargo test, plus ./scripts/run_parser_oracle_gate.sh check. Current blocker is pre-existing/non-owned workspace compile drift in extension_registry.rs + specialization_conformance.rs (unrelated lanes), which prevents clean global gate completion; parser-oracle run manifest emitted at artifacts/parser_oracle/20260224T075617Z/manifest.json with failed command attribution.",
    "status": "in_progress",
    "priority": 0,
    "issue_type": "task",
    "assignee": "CrimsonStone",
    "created_at": "2026-02-24T00:58:48.499893998Z",
    "created_by": "ubuntu",
    "updated_at": "2026-02-24T07:59:17.212697323Z",
    "source_repo": ".",
    "compaction_level": 0,
    "original_size": 0,
    "dependencies": [
      {
        "id": "bd-3spt",
        "title": "[PARSER-PHASE-0] ES2020 grammar + semantic completeness scalar baseline",
        "status": "closed",
        "priority": 0,
        "dependency_type": "blocks"
      },
      {
        "id": "bd-2mds",
        "title": "Epic: Parser Frontier Program (active)",
        "status": "in_progress",
        "priority": 0,
        "dependency_type": "parent-child"
      }
    ],
    "dependents": [
      {
        "id": "bd-ntq",
        "title": "[10.2] VM Core - Comprehensive Execution Epic",
        "status": "open",
        "priority": 0,
        "dependency_type": "blocks"
      },
      {
        "id": "bd-drjd",
        "title": "[PARSER-PHASE-1] Arena-Allocated Cache-Oblivious AST and Token Definitions",
        "status": "in_progress",
        "priority": 1,
        "dependency_type": "blocks"
      },
      {
        "id": "bd-1csl",
        "title": "[PHASE-A] Native VM Substrate Exit Gate",
        "status": "in_progress",
        "priority": 1,
        "dependency_type": "blocks"
      }
    ],
    "parent": "bd-2mds"
  }
]
